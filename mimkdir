#!/bin/sh

TOP_DIR=$(cd $(dirname $0);pwd)
DATA_DIR="$TOP_DIR/data"
IMAGES_DIR="$TOP_DIR/images"
VSCODE_EXTENSIONS_DIR="$HOME/.vscode/extensions"

main='
BEGIN {
    FS = ":";
}

function all_replacer(before, after, data) {
    split(data, splited_data, before);
    splited_data_length = length(splited_data);

    for (i = 0; i < splited_data_length; i += 1) {
        sub(before, after, data);
    }
    return data;
}

{
    key = all_replacer("\"", "", $1);
    key = all_replacer("\n", "", key);
    key = all_replacer("\x20", "", key);
    key = all_replacer("\x20", "", key);
    key = all_replacer("\x20", "", key);
    key = all_replacer("\x20", "", key);

    if (target == key) {
        value = all_replacer("\"", "", $2);
        value = all_replacer(",", "", value);
        value = all_replacer(" ", "", value);
        print(value);
    }
}
'

if [ ! -d $VSCODE_EXTENSIONS_DIR/pkief.material-icon-theme-*/icons ]; then
    ICONS_DIR="$TOP_DIR/icons"
else
    ICONS_DIR="$VSCODE_EXTENSIONS_DIR/pkief.material-icon-theme-*/icons"
fi

if [[ "$1" == *@* ]]; then
    type=$(echo $1 | cut -d '@' -f 2)
    name=$(echo $1 | cut -d '@' -f 1)
    icon=$(cat $DATA_DIR/folderIcons.json | awk -v target="$type" "$main")
else
    name=$1
    icon=$(cat $DATA_DIR/folderIcons.json | awk -v target="$1" "$main")
fi

if [ -z $icon ]; then
    mkdir ./$1
else
    if [ ! -f $IMAGES_DIR/$icon.png ]; then
        rsvg-convert -h 120 $ICONS_DIR/$icon.svg > $IMAGES_DIR/$icon.png
    fi
    mkdir ./$name && fileicon -q set ./$name $IMAGES_DIR/$icon.png
fi
